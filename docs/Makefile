BUILT_TRDL_BIN_PATH ?= go

all: regen_reference

regen_reference: _regen_reference_cli _regen_reference_vault_plugin _compile

_regen_reference_cli:
	@cd ../client && go install github.com/werf/trdl/client/cmd/trdl
	@$$BUILT_TRDL_BIN_PATH docs .

_regen_reference_vault_plugin:
	@cd ../server && go install github.com/werf/trdl/server/cmd/vault-plugin-docs
	@vault-plugin-docs generate-jekyll --base-pages-url /reference/vault_plugin --includes-dir _includes/reference/vault_plugin --pages-dir pages_en/reference/vault_plugin --sidebar-yml-path _data/sidebars/_vault_plugin.yml

_compile:
	@( \
		reference_sidebar_path="./_data/sidebars/reference.yml" ; \
		cli_partial_path="./_data/sidebars/_cli.yml" ; \
		vault_plugin_partial_path="./_data/sidebars/_vault_plugin.yml" ; \
		reference_partial_path="./_data/sidebars/_reference.yml" ; \
		echo "# This file is generated by the docs/Makefile" > $$reference_sidebar_path ; \
		echo "# DO NOT EDIT!" >> $$reference_sidebar_path ; \
		echo "" >> $$reference_sidebar_path ; \
		echo "# This is your sidebar TOC. The sidebar code loops through sections here and provides the appropriate formatting." >> $$reference_sidebar_path ; \
		echo "" >> $$reference_sidebar_path ; \
		cat "$$cli_partial_path" >> "$$reference_sidebar_path" ; \
		echo "" >> "$$reference_sidebar_path" ; \
		cat "$$vault_plugin_partial_path" >> "$$reference_sidebar_path" ; \
		echo "" >> "$$reference_sidebar_path" ; \
		cat "$$reference_partial_path" >> "$$reference_sidebar_path" ; \
	)

.PHONY: all regen_reference _regen_reference_cli _regen_reference_vault_plugin _compile
