version: "3"

silent: true

includes:
  server:
    taskfile: ./server/Taskfile.yaml
    dir: ./server
  client:
    taskfile: ./client/Taskfile.yaml
    dir: ./client
  e2e:
    taskfile: ./e2e/Taskfile.yaml
    dir: ./e2e
  docs:
    taskfile: ./docs/Taskfile.yaml
    dir: ./docs
  release:
    taskfile: ./release/Taskfile.yaml
    dir: ./release
  deps:
    taskfile: https://raw.githubusercontent.com/werf/common-ci/refs/heads/main/Taskfile.deps.yml
    flatten: true
    vars:
      paths: "e2e"

tasks:
  sign:
    desc: "Sign last version tag + origin/main and push signatures."
    cmds:
      - git fetch --tags -f
      - git signatures pull {{.CLI_ARGS}}
      - |
        for ref in {{.refs | default "$(git tag --sort=v:refname | tail -n1) origin/main"}}; do
          echo "Signing $ref..."
          git signatures add {{.CLI_ARGS}} $ref
          git signatures show {{.CLI_ARGS}} $ref
        done
      - git signatures push {{.CLI_ARGS}}

  format:
    desc: "Run all formattes in parallel."
    cmds:
      - task: server:format
      - task: client:format
      - task: e2e:format
      - task: docs:format:prettier
      - task: release:format

  lint:
    desc: "Run all linters."
    cmds:
      - task: server:lint
      - task: client:lint
      - task: e2e:lint
      - task: docs:lint:prettier
      - task: release:lint

  build:dev:all:
    desc: "Build all dev binaries."
    deps:
      - client:build:dev
      - server:build:dev
      - release:build:dev
    vars:
      version: "{{.version}}"

  build:dist:all:
    desc: "Build all release binaries."
    deps:
      - client:build:dist
      - server:build:dist
      - release:build:dist
    vars:
      version: "{{.version}}"

  _image:build:
    cmds:
      - docker build {{.CLI_ARGS}} -f "{{.dfilePath}}" -t "{{.imageName}}" "{{.context | default "."}}"

  image:build:builder:
    desc: 'Build main builder image. Important vars: "imageName".'
    cmds:
      - task: _image:build
        vars:
          dfilePath: trdl-builder.Dockerfile
          imageName:
            sh: "echo registry-write.werf.io/trdl/builder:$(git rev-parse HEAD)"

  _image:push:
    cmds:
      - docker push {{.CLI_ARGS}} "{{.imageName}}"

  image:publish:builder:
    desc: 'Build and publish main builder image. Important vars: "imageName".'
    deps:
      - image:build:builder
    cmds:
      - task: _image:push
        vars:
          imageName:
            sh: "echo registry-write.werf.io/trdl/builder:$(git rev-parse HEAD)"

  clean:
    desc: "Clean all temporary files and build artifacts."
    deps:
      - server:clean:binaries
      - client:clean:binaries
      - release:clean:binaries

  ci:setup:git-config:
    desc: "Setup git config."
    cmds:
      - git config --global init.defaultBranch main
      - git config --global user.name "borya"
      - git config --global user.email "borya@flant.com"

  ci:install:3p-git-signatures:
    desc: "Install 3p-git-signatires."
    cmds:
      - git clone https://github.com/werf/3p-git-signatures.git
      - cd 3p-git-signatures && make install
      - echo "~/.local/bin" >> $GITHUB_PATH
