networks:
  minio-net:

services:
  minio:
    container_name: minio-dev
    image: minio/minio@sha256:36433a735d87bbc2fed55674b3af936b57259f5cd2c544e869b8276d4d22b590
    ports:
      - "9000:9000"
    command: server /data
    networks:
      - minio-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/ready"]
      interval: 3s
      timeout: 2s
      retries: 10

  mc:
    image: minio/mc
    container_name: minio-client-dev
    entrypoint: /bin/sh
    stdin_open: true
    tty: true
    depends_on:
      - minio
    networks:
      - minio-net

  vault:
    image: ghcr.io/werf/trdl-dev-vault:latest
    platform: linux/amd64
    container_name: trdl-vault-dev
    working_dir: /app
    privileged: true
    environment:
      VAULT_PLUGIN_SECRETS_TRDL_PPROF_ENABLE: "1"
      VAULT_PLUGIN_SECRETS_TRDL_DEBUG: "1"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ../../../../../server:/app
      - $TEST_DIR:/test_dir
    ports:
      - 8200:8200
    command: >
      server -dev
      -dev-root-token-id=root
      -dev-plugin-dir=/app/vault/plugins
      -log-level trace
    healthcheck:
      test: ["CMD", "vault", "status"]
      interval: 2s
      timeout: 2s
      retries: 15
    networks:
      - minio-net